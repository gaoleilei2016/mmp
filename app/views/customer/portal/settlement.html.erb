<style type="text/css">
	html,body,.mui-content{
		height: 100%;
		overflow: hidden;
	}
	.mui-content{
		overflow: auto;
		padding-bottom: 60px;
	}
	.mui-table-view-cell.no_background:after{
		background: none;
	}
	.mui-table-view.no_background:after{
		background: none;
	}
</style>
<header class="my_top_nav mui-bar mui-bar-nav">
	<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
		<span class="mui-icon mui-icon-left-nav"></span>
	</button>
	<h1 class="mui-title">确认订单</h1>
</header>
<div class="mui-content" id="vue_content">
	<ul class="mui-table-view">
		<li class="mui-table-view-cell" style="padding: 22px 18px 14px;overflow: visible;">
			<div>
				<!-- <img class="mui-media-object mui-pull-left head-img" id="head-img" src="/assets/admin/TM.png"> -->
				<i class="fal fa-store-alt mui-media-object mui-pull-left" style="width: 42px;font-size:32px;color: #8A8782;text-align: center;"></i>
				<div class="mui-media-body">
					{{current_pharmacy.name}}
					<p class="mui-ellipsis">地址</p>
				</div>
			</div>
			<ul class="mui-table-view no_background" style="margin-top: 15px;">
				<li class="mui-table-view-cell no_background" v-for="drug in prescription.orders" style="padding-left: 0;">
					<div href="javascript:;" class="">
						<!-- <img class="mui-media-object mui-pull-left" src="/assets/customer/drug.jpg" style="border: 1px solid #ddd;border-radius: 50%;"> -->
						<i class="fal fa-capsules mui-media-object mui-pull-left" style="width: 42px;font-size:32px;color: #8A8782;text-align: center;"></i>
						<div class="mui-media-body">
							{{drug.title}}
							<p class="mui-ellipsis">
								{{drug.specification}}
								<span style="float: right;">¥ {{format_float(drug.price)}} x {{drug.total_quantity}} {{drug.unit}}</span>
							</p>
						</div>
					</div>
				</li>
			</ul>
		</li>
	</ul>
	<ul id="" class="mui-table-view mui-table-view-chevron" style="margin: 16px 0 36px;">
		<li class="mui-table-view-cell mui-media">
			<a href="#picture" class="mui-btn-outlined">
				<div class="mui-media-body">
					支付方式
					<span class='mui-pull-right' style="color: #999;">
						<template v-if="pay_type=='online'">在线支付</template>
						<template v-if="pay_type=='offline'">到店支付</template>
					</span>
				</div>
			</a>
		</li>
		<li class="mui-table-view-cell mui-media">
			<a href="javascript:mui.toast('暂无可用');" class="mui-navigate-right">
				<div class="mui-media-body">
					抵用券
					<span class='mui-pull-right' style="color: #999;">暂无可用</span>
					<!-- <span class='mui-pull-right' style="color: red;">-5 元</span> -->
				</div>
			</a>
		</li>
		<li class="mui-table-view-cell">
			<span>发票</span>
			<div class="mui-switch mui-switch-mini">
				<div class="mui-switch-handle"></div>
			</div>
		</li>
	</ul>
	<div id="picture" class="mui-popover mui-popover-action mui-popover-bottom">
		<ul class="mui-table-view">
			<li class="mui-table-view-cell">
				<a href="javascript:;" @click="pay_type='online';mui('#picture').popover('toggle');">在线支付</a>
			</li>
			<li class="mui-table-view-cell">
				<a href="javascript:;" @click="pay_type='offline';mui('#picture').popover('toggle');">到店支付</a>
			</li>
		</ul>
		<ul class="mui-table-view">
			<li class="mui-table-view-cell">
				<a href="#picture"><b>取消</b></a>
			</li>
		</ul>
	</div>
	<form action="/interfaces/save_order" method="post" style="display: none; margin: 16px 0 36px;">
		<input type="text" name="order[pay_type]" v-model="pay_type">
		<input type="text" name="order[hospital_id]" v-model="prescription.org_id">
		<input type="text" name="order[hospital_name]" v-model="prescription.org_name">
		<input type="text" name="order[pharmacy_id]" v-model="current_pharmacy.id">
		<input type="text" name="order[pharmacy_name]" v-model="current_pharmacy.name">
		<select v-if="prescription.prescription_ids" multiple="multiple" name="order[prescription_ids][]" v-model="prescription.prescription_ids">
			<option v-for="id in prescription.prescription_ids" key="id">{{id}}</option>
		</select>
	</form>
	<div style="background: #fff;position: fixed;bottom: 0px;z-index: 998;height: 60px;width: 100%;font-size: 20px;line-height: 60px;">
		<a href="javascript:;" @click="submit_form" style="float: right;width: 130px;color: #fff;background: red;height: 100%;text-align: center;">提交订单</a>
		<div style="overflow: hidden;padding-right: 10px;text-align: right;">总金额 <span style="color: red;">¥ {{format_float(prescription.total_price)}}</span></div>
	</div>
</div>
<script type="text/javascript">
	$("#bottom_tabs").remove();
	var current_app = new Vue({
		el:"#vue_content",
		data:{
			current_pharmacy:{},
			prescription:{},
			fapiao:false,
			pay_type:'online', // online | offline
		},
		methods:{
			xxxxx:function() {
				alert('xxxxx')
			},
			submit_form:function() {
				var _this = this;
				if (!_this.prescription.org_id) {
					mui.toast('医院获取失败');
					return false;
				}
				if (!_this.current_pharmacy.id) {
					mui.toast('药房获取失败');
					return false;
				}
				$('form').submit();
			},
			format_float:function(value) {
				return (parseFloat(value)||0).toFixed(2);
			},
			get_current_pharmacy:function(item) {
				var _this = this;
				$.ajax({
					url:"/interfaces/get_current_pharmacy",
					success:function(json) {
						_this.current_pharmacy = json.pharmacy;
					}
				})
			},
			get_prescriptions:function() {
				var _this = this;
				$("#loading").show();
				$.ajax({
					url:'/interfaces/get_prescriptions_cart',
					success:function(json) {
						if (json.flag) {
							_this.prescription = json.data;
						}else{
							_this.$message(json.info);
						}
					},
					complete:function() {
						$("#loading").hide();
					},
					error:error_fun
				})
			},
		},
		mounted:function() {
			var _this = this;
			this.get_current_pharmacy();
			this.get_prescriptions();
			mui('.mui-content .mui-switch').each(function() {
				this.addEventListener('toggle', function(event) {
					_this.fapiao = event.detail.isActive;
				});
			});
			// mui('body').on('tap', '.mui-popover-action li>a', function() {
			// 	var a = this,
			// 		parent;
			// 	//根据点击按钮，反推当前是哪个actionsheet
			// 	for (parent = a.parentNode; parent != document.body; parent = parent.parentNode) {
			// 		if (parent.classList.contains('mui-popover-action')) {
			// 			break;
			// 		}
			// 	}
			// 	//关闭actionsheet
			// 	mui('#' + parent.id).popover('toggle');
			// 	info.innerHTML = "你刚点击了\"" + a.innerHTML + "\"按钮";
			// })
		}
	})
</script>
