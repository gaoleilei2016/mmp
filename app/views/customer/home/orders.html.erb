<style type="text/css">
	html,body,.mui-content{
		height: 100%;
		overflow: hidden;
	}
	.mui-content{
		overflow: auto;
		/*padding-bottom: 60px;*/
	}
	.mui-table-view-cell.no_background:after{
		background: none;
	}
	.mui-table-view.no_background:after{
		background: none;
	}
	.mui-slider .mui-slider-group .mui-slider-item .mui-table-view:after, .mui-slider .mui-slider-group .mui-slider-item .mui-table-view:before{
		height: 1px;
	}
	.mui-content .mui-active{
		background: none !important;
	}
</style>
<header class="my_top_nav mui-bar mui-bar-nav">
	<a href="/customer/home" class="mui-left mui-btn mui-btn-link mui-btn-nav mui-pull-left">
		<span class="mui-icon mui-icon-left-nav"></span>
	</a>
	<h1 class="mui-title">我的订单</h1>
</header>
<div class="mui-content" id="vue_content">
	<div class="mui-slider" style="height: 100%;">
		<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
			<a class="mui-control-item" href="#item1mobile">
				可使用
			</a>
			<a class="mui-control-item" href="#item2mobile">
				全部订单
			</a>
		</div>
		<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-6"></div>
		<div class="mui-slider-group" style="height: calc( 100% - 40px );">
			<div id="item1mobile" style="overflow: auto;" class="mui-slider-item mui-control-content mui-active">
				<my-component :orders="not_used_orders"></my-component>
			</div>
			<div id="item2mobile" style="overflow: auto;" class="mui-slider-item mui-control-content">
				<my-component :orders="orders"></my-component>
			</div>
		</div>
	</div>
</div>
<template id="my_template">
	<div style="">
		<div v-for="order in orders" style="margin-bottom: 16px;">
			<ul class="mui-table-view" style="margin-bottom: 8px;">
				<li class="mui-table-view-cell">
					<a :href="'/customer/home/order?id='+order.id">
						<span>No: {{order.order_code}}</span>
						<span style="float: right;color: #F55742;">
							<span v-if="order.payment_type=='1'">
								<span v-if="order.status=='1'">未付款</span>
								<span v-if="order.status=='2'">已付款</span>
								<span v-if="order.status=='3'">未发货</span>
								<span v-if="order.status=='4'">已发货</span>
								<span v-if="order.status=='5'">交易成功</span>
								<span v-if="order.status=='6'">交易关闭</span>
								<span v-if="order.status=='7'">交易取消</span>
							</span>
							<span v-if="order.payment_type=='2'">到店支付</span>
						</span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a :href="'/customer/home/order?id='+order.id">
						<!-- <img class="mui-media-object mui-pull-left head-img" id="head-img" src="/assets/admin/TM.png"> -->
						<i class="fal fa-store-alt mui-media-object mui-pull-left" style="width: 42px;font-size:32px;color: #8A8782;text-align: center;"></i>
						<div class="mui-media-body">
							<span>{{order.organ.name||"　"}}</span>
							<p class="mui-ellipsis" style="font-size: 12px;padding-right: 64px;">{{order.organ.addr||"　"}}</p>
						</div>
						<ul class="mui-table-view" style="margin: 15px 0;">
							<li class="mui-table-view-cell no_background" v-for="drug in order.drugs" style="padding-left: 0;">
								<div href="javascript:;" class="">
									<!-- <img class="mui-media-object mui-pull-left" src="/assets/customer/drug.jpg" style="border: 1px solid #ddd;border-radius: 50%;"> -->
									<i class="fal fa-capsules mui-media-object mui-pull-left" style="width: 42px;font-size:32px;color: #8A8782;text-align: center;"></i>
									<div class="mui-media-body">
										{{drug.name}}
										<p class="mui-ellipsis">
											{{drug.specifications}}
											<span style="float: right;">¥ {{$parent.format_float(drug.price)}} x {{drug.quantity}} {{drug.unit}}</span>
										</p>
									</div>
								</div>
							</li>
						</ul>
						<div style="line-height: 33px;">
							合计 <span style="color: #F55742;">¥ {{$parent.format_float(order.total_price)}}</span>
							<span style="float: right;" class="common_grey">{{order.reason}}</span>
						</div>
					</a>
				</li>
			</ul>
			<div style="text-align: right;padding-right: 8px;">
				<button type="button" @click="$parent.cancel_order(order.id)" v-if="order.status=='1'">取消订单</button>
				<button type="button" :onclick="'location.href=\'/customer/portal/pay?id='+order.id+'\''" v-if="order.status=='1'">去支付</button>
				<button type="button" @click="$parent.refund_order(order.id)" v-if="order.status=='2'">申请退款</button>
			</div>
		</div>
	</div>
</template>
<script type="text/javascript">
	Vue.component('my-component', {
		template:"#my_template",
		props: ['orders'],
	})
	new Vue({
		el:"#vue_content",
		data:{
			orders:[],
		},
		computed:{
			not_used_orders:function() {
				return this.orders.filter(function(item) {
					return item.status=='1'||item.status=='1';
				})
			}
		},
		methods:{
			refund_order:function(id) {
				$("#loading").show();
				$.ajax({
					url:"/interfaces/refund_order",
					type:'post',
					data:{id:id},
					success:function(json) {
						if (json.flag) {
							location.reload();
						}else{
						}
						mui.toast(json.info);
					},
					complete:function() {
						$("#loading").hide();
					},
					error:function(e) {
						mui.toast("订单操作失败");
					}
				})
			},
			cancel_order:function(id) {
				$("#loading").show();
				$.ajax({
					url:"/interfaces/cancel_order",
					type:'post',
					data:{id:id},
					success:function(json) {
						if (json.ret_code == "0") {
							location.reload();
						}else{
						}
						mui.toast(json.info);
					},
					complete:function() {
						$("#loading").hide();
					},
					error:function(e) {
						mui.toast("订单操作失败");
					}
				})
			},
			format_float:function(value) {
				return (parseFloat(value)||0).toFixed(2);
			},
			get_orders:function() {
				var _this = this;
				$("#loading").show();
				$.ajax({
					url:'/interfaces/get_orders',
					data:{per:10},
					success:function(json) {
						if (json.flag) {
							_this.orders = json.rows;
						}else{
							mui.toast(json.info);
						}
					},
					complete:function() {
						$("#loading").hide();
					},
					error:function(e) {
						mui.toast("订单获取失败");
					}
				})
			},
		},
		mounted:function() {
			this.get_orders();
			// $("#vue_content").on("touchstart",function(e) {
			// 	console.log( 'xxxxxxxx 0',e );
			// })
			// $("#vue_content").on("touchmove",function(e) {
			// 	console.log( 'xxxxxxxx 1',e );
			// })
			// alert( navigator.userAgent );
			if( navigator.userAgent.indexOf("Mac")>-1 ){
				$("#vue_content").on("touchstart", function(e) {
					// e.preventDefault();
					startX = e.originalEvent.changedTouches[0].pageX,
					startY = e.originalEvent.changedTouches[0].pageY;
				});
				$("#vue_content").on("touchmove", function(e) {
					// e.preventDefault();
					moveEndX = e.originalEvent.changedTouches[0].pageX,
					moveEndY = e.originalEvent.changedTouches[0].pageY,
					X = moveEndX - startX,
					Y = moveEndY - startY;

					if ( Math.abs(X) > Math.abs(Y) && X > 0 ) {
						// console.log("left 2 right");
						e.preventDefault();
						return false
					}
					else if ( Math.abs(X) > Math.abs(Y) && X < 0 ) {
						// console.log("right 2 left");
						e.preventDefault();
						return false
					}
					else if ( Math.abs(Y) > Math.abs(X) && Y > 0) {
						// console.log("top 2 bottom");
					}
					else if ( Math.abs(Y) > Math.abs(X) && Y < 0 ) {
						// console.log("bottom 2 top");
					}
					else{
						// console.log("just touch");
					}
				});
			}
		}
	})
</script>